<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Totem de Vota√ß√£o - Money Talks</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body { font-family: Arial; background:#000; color:#fff; text-align:center; padding:20px; }
h1 { margin-bottom:20px; }
input { width:80%; max-width:400px; padding:12px; font-size:18px; margin-bottom:20px; border-radius:10px; border:none; }
button { display:block; width:80%; max-width:350px; margin:8px auto; padding:16px; font-size:18px; border:none; border-radius:12px; cursor:pointer; background:#e10600; color:white; }
button:disabled { background:gray; cursor:not-allowed; }
.rankItem { font-size:20px; margin:6px 0; }
.category { font-size:22px; margin-top:25px; color:#00bfff; text-decoration:underline; }
.artist { font-weight:bold; margin-top:10px; }
.executada { background:#444 !important; }
</style>
</head>
<body>

<div id="conteudo"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCxpYTjgDElVqhhG-OUXJGIWXapifaZ9Zw",
  authDomain: "totem-12c8a.firebaseapp.com",
  databaseURL: "https://totem-12c8a-default-rtdb.firebaseio.com",
  projectId: "totem-12c8a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const conteudo = document.getElementById("conteudo");

let musicasExecutadas = {};
let votosBloqueados = {};

db.ref("sistemaStatus").on("value", snap => {
  const status = snap.val();
  if(status !== "on"){
    conteudo.innerHTML = `<h1>üéµ Sistema dispon√≠vel apenas nos shows!</h1><div>üîí Vota√ß√£o indispon√≠vel</div>`;
    return;
  }

  conteudo.innerHTML = `
    <h1>Escolha a pr√≥xima m√∫sica</h1>
    <input type="text" id="searchInput" placeholder="üîç Buscar m√∫sica ou artista">
    <div id="buttons"></div>
    <h2>Ranking ao Vivo</h2>
    <div id="rankingList"></div>
  `;
  iniciarSistema();
});

function iniciarSistema(){
  const container = document.getElementById("buttons");

  const musicas = {
    "Rock Nacional": {
      "Os Paralamas do Sucesso":["Meu Erro"],
      "Skank":["Garota Nacional","Sutilmente"],
      "Bar√£o Vermelho":["Bete Balan√ßo"],
      "Legi√£o Urbana":["Pais E Filhos","Tempo Perdido"],
      "Cazuza":["Exagerado"],
      "Frejat":["Segredos"],
      "Tit√£s":["Pra Dizer Adeus"],
      "Lob√£o":["Me Chama","R√°dio Bl√°"]
    },
    "Cl√°ssicos Internacionais": {
      "Elvis Presley":["Suspicious Minds"],
      "The Beatles":["Come Together","Hey Jude","Let It Be"],
      "Queen":["Another One Bites The Dust"],
      "Pink Floyd":["Wish You Were Here"]
    },
    "Soul / Brasil": { "Tim Maia":["Gostava Tanto de Voc√™"] }
  };

  function criarBotoes(filter=""){
    container.innerHTML="";
    let encontrou=false;

    Object.keys(musicas).forEach(cat=>{
      let catDiv=document.createElement("div");
      let catTem=false;

      Object.keys(musicas[cat]).forEach(artista=>{
        let artistaDiv=document.createElement("div");
        let artTem=false;

        musicas[cat][artista].forEach(musica=>{
          if(filter && !musica.toLowerCase().includes(filter) && !artista.toLowerCase().includes(filter)) return;
          encontrou=true;
          catTem=true;
          artTem=true;

          let btn = document.createElement("button");
          btn.setAttribute("data-nome", musica);
          btn.setAttribute("id","btn-"+musica.replace(/\s+/g,"_"));

          atualizarBotao(btn, musica);
          artistaDiv.appendChild(btn);
        });

        if(artTem){
          let artTitle = document.createElement("div");
          artTitle.className="artist";
          artTitle.innerText = artista;
          catDiv.appendChild(artTitle);
          catDiv.appendChild(artistaDiv);
        }
      });

      if(catTem){
        let catTitle = document.createElement("div");
        catTitle.className="category";
        catTitle.innerText = cat;
        container.appendChild(catTitle);
        container.appendChild(catDiv);
      }
    });

    if(!encontrou) container.innerHTML="<h2>‚ùå M√∫sica n√£o encontrada</h2>";
  }

  function atualizarBotao(btn, musica){
    if(musicasExecutadas[musica]){
      btn.innerText="üîí "+musica+" (J√° executada)";
      btn.disabled=true;
      btn.classList.add("executada");
    } else if(votosBloqueados[musica]){
      btn.innerText=musica+" ‚è≥ Aguarde "+votosBloqueados[musica]+"s";
      btn.disabled=true;
    } else {
      btn.innerText=musica;
      btn.disabled=false;
      btn.onclick=()=>voteMusica(musica, btn);
    }
  }

  function voteMusica(musica, btn){
    if(votosBloqueados[musica]) return;
    db.ref("ranking/"+musica).transaction(v=>(v||0)+1);

    votosBloqueados[musica] = 30;
    atualizarBotao(btn, musica);

    const interval = setInterval(()=>{
      votosBloqueados[musica]--;
      atualizarBotao(btn, musica);
      if(votosBloqueados[musica]<=0){
        clearInterval(interval);
        delete votosBloqueados[musica];
        atualizarBotao(btn, musica);
      }
    },1000);
  }

  document.getElementById("searchInput").addEventListener("input", e=>{
    criarBotoes(e.target.value.toLowerCase());
  });

  // Atualiza bot√µes em tempo real quando o admin marca executadas
  db.ref("executadas").on("child_added", snap=>{
    musicasExecutadas[snap.key] = true;
    const btn = document.getElementById("btn-"+snap.key.replace(/\s+/g,"_"));
    if(btn) atualizarBotao(btn, snap.key);
  });
  db.ref("executadas").on("child_removed", snap=>{
    delete musicasExecutadas[snap.key];
    const btn = document.getElementById("btn-"+snap.key.replace(/\s+/g,"_"));
    if(btn) atualizarBotao(btn, snap.key);
  });

  db.ref("ranking").on("value", snap=>{
    const data = snap.val()||{};
    const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]);
    let html="";
    sorted.forEach((item,i)=>html+="<div class='rankItem'>"+(i+1)+"¬∫ - "+item[0]+" ("+item[1]+" votos)</div>");
    document.getElementById("rankingList").innerHTML = html;
  });

  criarBotoes();
}
</script>
</body>
</html>
