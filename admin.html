<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Totem M√∫sica</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body { font-family: Arial; background:#111; color:#fff; text-align:center; padding:20px; }
h1 { margin-bottom:20px; }

button {
margin:6px;
padding:10px 14px;
font-size:14px;
border:none;
border-radius:8px;
cursor:pointer;
}

.exec { background:#e10600; color:#fff; }
.unlock { background:#00bfff; color:#000; }
.reset { background:orange; color:#000; margin-top:20px; }
.on { background:#00cc66; color:#000; }
.off { background:#ff3333; color:#fff; }

.rankItem { margin:8px 0; font-size:18px; }
.statusBox { margin:15px 0; font-size:20px; }
</style>
</head>
<body>

<h1>üîê Painel Administrativo</h1>

<div class="statusBox">
Status do Sistema: <span id="statusSistema">Carregando...</span>
<br>
<button class="on" onclick="ativarSistema()">ATIVAR SISTEMA</button>
<button class="off" onclick="desativarSistema()">DESATIVAR SISTEMA</button>
</div>

<div id="rankingList"></div>

<button class="reset" onclick="resetar()">RESETAR SISTEMA</button>

<script>
const urlParams = new URLSearchParams(window.location.search);
if(urlParams.get("senha") !== "12345"){
  document.body.innerHTML="<h2>Acesso negado</h2>";
  throw new Error("Sem acesso");
}

const firebaseConfig = {
  apiKey: "AIzaSyCxpYTjgDElVqhhG-OUXJGIWXapifaZ9Zw",
  authDomain: "totem-12c8a.firebaseapp.com",
  databaseURL: "https://totem-12c8a-default-rtdb.firebaseio.com",
  projectId: "totem-12c8a"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ===== CONTROLE ON/OFF =====
function ativarSistema(){
  database.ref("sistemaStatus").set("on");
  alert("Sistema ativado!");
}

function desativarSistema(){
  database.ref("sistemaStatus").set("off");
  alert("Sistema desativado!");
}

database.ref("sistemaStatus").on("value",snap=>{
  let status = snap.val();
  if(!status){
    database.ref("sistemaStatus").set("off");
    status = "off";
  }
  document.getElementById("statusSistema").innerText =
    status === "on" ? "üü¢ ATIVO" : "üî¥ DESATIVADO";
});

// ===== RESET =====
function resetar(){
  if(confirm("Tem certeza que deseja resetar tudo?")){
    database.ref("ranking").set({});
    database.ref("executadas").set({});
    alert("Sistema resetado!");
  }
}

// ===== RANKING ADMIN EM TEMPO REAL =====
function atualizarRanking(){
  database.ref("ranking").once("value").then(snap=>{
    const data = snap.val() || {};
    const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]);
    let html="";
    sorted.forEach(item=>{
      html+=`
        <div class="rankItem">
        ${item[0]} - ${item[1]} votos
        <br>
        <button class="exec" onclick="executar('${item[0]}')">Marcar como Executada</button>
        <button class="unlock" onclick="desbloquear('${item[0]}')">Desbloquear</button>
        </div>
      `;
    });
    document.getElementById("rankingList").innerHTML=html;
  });
}

// Atualiza ranking automaticamente quando muda qualquer m√∫sica executada
database.ref("executadas").on("value",snap=>{
  atualizarRanking();
});

// Atualiza ranking automaticamente quando muda o ranking
database.ref("ranking").on("value",snap=>{
  atualizarRanking();
});

// ===== FUN√á√ïES DE EXECUTAR E DESBLOQUEAR =====
function executar(musica){
  database.ref("executadas/"+musica).set(true);
  alert("M√∫sica marcada como executada!");
}

function desbloquear(musica){
  database.ref("executadas/"+musica).set(false);
  alert("M√∫sica desbloqueada!");
}

// Primeira atualiza√ß√£o ao carregar
atualizarRanking();
</script>
</body>
</html>
